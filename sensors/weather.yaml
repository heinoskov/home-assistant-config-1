#
# Dark Sky weather
#
# @link https://home-assistant.io/components/sensor.darksky/
#
- platform: darksky
  api_key: !secret darksky_api_key
  scan_interval: 180
  forecast:
    - 0
    - 1
    - 2
    - 3
    - 4
  monitored_conditions:
    - summary
    - minutely_summary
    - hourly_summary
    - daily_summary
    - icon
    - uv_index
    - temperature
    - temperature_high
    - temperature_low
    - apparent_temperature
    - apparent_temperature_high
    - humidity
    - pressure
    - wind_speed
    - wind_bearing
    - precip_probability
    - precip_type


#
# Outside temperature and humidity
#
# Information is rounded to integers, because decimal points here are not useful
# for human consumption ...and because the hyper-local temperature is likely off
# by a few degrees anyway. This isn't a laboratory after all!
#
- platform: template
  sensors:
    outside_temperature:
      friendly_name: Temperature
      icon_template: mdi:thermometer
      unit_of_measurement: '°C'
      value_template: >-
        {{ states('sensor.dark_sky_temperature') | round }}

    outside_humidity:
      friendly_name: Humidity
      icon_template: mdi:water-percent
      unit_of_measurement: '%'
      value_template: >-
        {{ states('sensor.dark_sky_humidity') | round }}


#
# Friedly weather report
#
# These add "Feels like X˚" to the apparent reading if any, to make this data
# easier to consume.
#
- platform: template
  sensors:
    feels_like:
      friendly_name: Feels Like
      value_template: >-
        {% set temperature = states('sensor.outside_temperature') | round %}
        {% set apparent = states('sensor.dark_sky_apparent_temperature') | round %}

        {% if apparent != 'unknown' and apparent != temperature %}
          Feels like {{ apparent }}˚
        {% endif %}

    feels_like_1:
      friendly_name: Feels Like
      value_template: >-
        {% set temperature = states('sensor.dark_sky_daytime_high_temperature_1d') | round %}
        {% set apparent = states('sensor.dark_sky_daytime_high_apparent_temperature_1d') | round %}

        {% if apparent != 'unknown' and apparent != temperature %}
          Will feel like {{ apparent }}˚
        {% endif %}

    feels_like_2:
      friendly_name: Feels Like
      value_template: >-
        {% set temperature = states('sensor.dark_sky_daytime_high_temperature_2d') | round %}
        {% set apparent = states('sensor.dark_sky_daytime_high_apparent_temperature_2d') | round %}

        {% if apparent != 'unknown' and apparent != temperature %}
          Will feel like {{ apparent }}˚
        {% endif %}

    feels_like_3:
      friendly_name: Feels Like
      value_template: >-
        {% set temperature = states('sensor.dark_sky_daytime_high_temperature_3d') | round %}
        {% set apparent = states('sensor.dark_sky_daytime_high_apparent_temperature_3d') | round %}

        {% if apparent != 'unknown' and apparent != temperature %}
          Will feel like {{ apparent }}˚
        {% endif %}

    feels_like_4:
      friendly_name: Feels Like
      value_template: >-
        {% set temperature = states('sensor.dark_sky_daytime_high_temperature_4d') | round %}
        {% set apparent = states('sensor.dark_sky_daytime_high_apparent_temperature_4d') | round %}

        {% if apparent != 'unknown' and apparent != temperature %}
          Will feel like {{ apparent }}˚
        {% endif %}

    # Based partially on https://en.wikipedia.org/wiki/Heat_index#Table_of_values
    feels_like_emoji:
      friendly_name: Feels Like Emoji
      value_template: >-
        {% set temperature = states('sensor.outside_temperature') | round %}
        {% set apparent = states('sensor.dark_sky_apparent_temperature') | round %}

        {% if apparent != 'unknown' and apparent != temperature %}
          {% set temperature = apparent %}
        {% endif %}

        {% if temperature >= 52 %}
          🥵
        {% elif temperature >= 41 %}
          🤒
        {% elif temperature >= 33 %}
          😓
        {% elif temperature >= 27 %}
          😎
        {% elif temperature >= 19 %}
          😀
        {% elif temperature >= 11 %}
          😕
        {% elif temperature >= 1 %}
          😬
        {% elif temperature >= -10 %}
          😨
        {% elif temperature >= -20 %}
          🥶
        {% elif temperature <= 30 %}
          🧊
        {% else %}
          ❓
        {% endif %}

    outside_condition_0:
      friendly_name: Condition
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_0d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          mdi:weather-sunny
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          mdi:weather-partly-cloudy
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon_0d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          Clear
        {% elif icon == 'cloudy' %}
          Cloudy
        {% elif icon == 'fog' %}
          Fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          Partly Cloudy
        {% elif icon == 'rain' %}
          Rain
        {% elif icon == 'sleet' %}
          Sleet
        {% elif icon == 'snow' %}
          Snow
        {% elif icon == 'wind' %}
          Windy
        {% else %}
          unknown
        {% endif %}

    outside_condition_1:
      friendly_name: Condition
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_1d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          mdi:weather-sunny
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          mdi:weather-partly-cloudy
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon_1d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          Clear
        {% elif icon == 'cloudy' %}
          Cloudy
        {% elif icon == 'fog' %}
          Fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          Partly Cloudy
        {% elif icon == 'rain' %}
          Rain
        {% elif icon == 'sleet' %}
          Sleet
        {% elif icon == 'snow' %}
          Snow
        {% elif icon == 'wind' %}
          Windy
        {% else %}
          unknown
        {% endif %}

    outside_condition_2:
      friendly_name: Condition
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_2d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          mdi:weather-sunny
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          mdi:weather-partly-cloudy
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon_2d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          Clear
        {% elif icon == 'cloudy' %}
          Cloudy
        {% elif icon == 'fog' %}
          Fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          Partly Cloudy
        {% elif icon == 'rain' %}
          Rain
        {% elif icon == 'sleet' %}
          Sleet
        {% elif icon == 'snow' %}
          Snow
        {% elif icon == 'wind' %}
          Windy
        {% else %}
          unknown
        {% endif %}

    outside_condition_3:
      friendly_name: Condition
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_3d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          mdi:weather-sunny
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          mdi:weather-partly-cloudy
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon_3d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          Clear
        {% elif icon == 'cloudy' %}
          Cloudy
        {% elif icon == 'fog' %}
          Fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          Partly Cloudy
        {% elif icon == 'rain' %}
          Rain
        {% elif icon == 'sleet' %}
          Sleet
        {% elif icon == 'snow' %}
          Snow
        {% elif icon == 'wind' %}
          Windy
        {% else %}
          unknown
        {% endif %}

    outside_condition_4:
      friendly_name: Condition
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_4d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          mdi:weather-sunny
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          mdi:weather-partly-cloudy
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon_4d') %}

        {% if icon in ['clear-day', 'clear-night'] %}
          Clear
        {% elif icon == 'cloudy' %}
          Cloudy
        {% elif icon == 'fog' %}
          Fog
        {% elif icon in ['partly-cloudy-day', 'partly-cloudy-night'] %}
          Partly Cloudy
        {% elif icon == 'rain' %}
          Rain
        {% elif icon == 'sleet' %}
          Sleet
        {% elif icon == 'snow' %}
          Snow
        {% elif icon == 'wind' %}
          Windy
        {% else %}
          unknown
        {% endif %}

    weather_summary:
      entity_id:
        - sensor.dark_sky_temperature
        - sensor.dark_sky_apparent_temperature
        - sensor.dark_sky_minutely_summary
      friendly_name_template: >-
        {% set temperature = states('sensor.dark_sky_temperature') | round %}
        {% set apparent = states('sensor.dark_sky_apparent_temperature') | round %}
        {% set summary = states('sensor.dark_sky_minutely_summary') %}

        {% if summary == 'unknown' %}
          {% set summary = states('sensor.dark_sky_summary') %}
        {% endif %}

        {{ summary }} {% if apparent != 'unknown' and apparent != temperature -%}
          Feels like {{ apparent }}˚.
        {% endif %}
      icon_template: >-
        {{ state_attr('sensor.dark_sky_summary', 'icon') }}
      value_template: >-
        {% if states('sensor.dark_sky_temperature') != 'unknown' %}
          {{ states('sensor.dark_sky_temperature') | round }}˚
        {%- endif -%}
        {%- if states('sensor.dark_sky_summary') != 'unknown' -%}
          {{ ' ' ~ states('sensor.dark_sky_summary') }}.
        {%- endif %}

    weather_details:
      friendly_name: Weather Details
      icon_template: >-
        {{ state_attr('sensor.dark_sky_summary', 'icon') }}
      value_template: >-
        {% set temperature = states('sensor.dark_sky_temperature') | round %}
        {% set apparent = states('sensor.dark_sky_apparent_temperature') | round %}
        {% set summary = states('sensor.dark_sky_minutely_summary') %}

        {% if summary == 'unknown' %}
          {% set summary = states('sensor.dark_sky_summary') %}
        {% endif %}

        {% if apparent != 'unknown' and apparent != temperature %}
          Feels like {{ apparent }}˚. {{ summary }}
        {% else %}
          {{ summary }}
        {% endif %}


#
# Chances of precipitation
#
# These templates improve the reading comprehension about the chances of rain.
#
# @see /appdaemon/dashboards/Weather.dash
#
- platform: template
  sensors:
    precip_probability:
      friendly_name_template: >-
        {% set precip = states('sensor.dark_sky_precip') %}

        {% if precip != 'unknown' %}
          Chance of {{ precip | title }}
        {% else %}
          Precip Probability
        {% endif %}
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          {{ precip }} %
        {% else %}
          —
        {% endif %}

    precip_probability_0:
      friendly_name_template: >-
        {% set precip = states('sensor.dark_sky_precip_0d') %}

        {% if precip != 'unknown' %}
          Chance of {{ precip | title }}
        {% else %}
          Precip Probability
        {% endif %}
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_0d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          {{ precip }} %
        {% else %}
          —
        {% endif %}

    precip_probability_1:
      friendly_name_template: >-
        {% set precip = states('sensor.dark_sky_precip_1d') %}

        {% if precip != 'unknown' %}
          Chance of {{ precip | title }}
        {% else %}
          Precip Probability
        {% endif %}
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_1d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          {{ precip }} %
        {% else %}
          —
        {% endif %}

    precip_probability_2:
      friendly_name_template: >-
        {% set precip = states('sensor.dark_sky_precip_2d') %}

        {% if precip != 'unknown' %}
          Chance of {{ precip | title }}
        {% else %}
          Precip Probability
        {% endif %}
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_2d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          {{ precip }} %
        {% else %}
          —
        {% endif %}

    precip_probability_3:
      friendly_name_template: >-
        {% set precip = states('sensor.dark_sky_precip_3d') %}

        {% if precip != 'unknown' %}
          Chance of {{ precip | title }}
        {% else %}
          Precip Probability
        {% endif %}
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_3d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          {{ precip }} %
        {% else %}
          —
        {% endif %}

    precip_probability_4:
      friendly_name_template: >-
        {% set precip = states('sensor.dark_sky_precip_4d') %}

        {% if precip != 'unknown' %}
          Chance of {{ precip | title }}
        {% else %}
          Precip Probability
        {% endif %}
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_4d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          {{ precip }} %
        {% else %}
          —
        {% endif %}

    precip_probability_friendly:
      friendly_name: Probability of Precipitation
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          precip: {{ precip }} %
        {% else %}
          no precipitation
        {% endif %}

    precip_probability_friendly_1:
      friendly_name: Probability of Precipitation
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_1d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          precip: {{ precip }} %
        {% else %}
          no precipitation
        {% endif %}

    precip_probability_friendly_2:
      friendly_name: Probability of Precipitation
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_2d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          precip: {{ precip }} %
        {% else %}
          no precipitation
        {% endif %}

    precip_probability_friendly_3:
      friendly_name: Probability of Precipitation
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_3d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          precip: {{ precip }} %
        {% else %}
          no precipitation
        {% endif %}

    precip_probability_friendly_4:
      friendly_name: Probability of Precipitation
      icon_template: mdi:percent
      value_template: >-
        {% set precip = states('sensor.dark_sky_precip_probability_4d') | int(-1) %}

        {% if precip < 0 %}
          unknown
        {% elif precip > 0 %}
          precip: {{ precip }} %
        {% else %}
          no precipitation
        {% endif %}


#
# Friendly humidity
#
# Makes humidity readings easier to understand by rounding them.
#
# @see /appdaemon/dashboards/Weather.dash
#
- platform: template
  sensors:
    outside_humidity_0:
      friendly_name: Humidity
      unit_of_measurement: '%'
      icon_template: mdi:water-percent
      value_template: >-
        {{ states('sensor.dark_sky_humidity_0d') | round }}

    outside_humidity_1:
      friendly_name: Humidity
      unit_of_measurement: '%'
      icon_template: mdi:water-percent
      value_template: >-
        {{ states('sensor.dark_sky_humidity_1d') | round }}

    outside_humidity_2:
      friendly_name: Humidity
      unit_of_measurement: '%'
      icon_template: mdi:water-percent
      value_template: >-
        {{ states('sensor.dark_sky_humidity_2d') | round }}

    outside_humidity_3:
      friendly_name: Humidity
      unit_of_measurement: '%'
      icon_template: mdi:water-percent
      value_template: >-
        {{ states('sensor.dark_sky_humidity_3d') | round }}

    outside_humidity_4:
      friendly_name: Humidity
      unit_of_measurement: '%'
      icon_template: mdi:water-percent
      value_template: >-
        {{ states('sensor.dark_sky_humidity_4d') | round }}


#
# Friendly temperatures
#
# Makes temperature readings easier to understand by rounding them and adding
# strings.
#
# @see /appdaemon/dashboards/Weather.dash
#
- platform: template
  sensors:
    outside_temperature_0:
      friendly_name_template: >-
        {% set date = states('sensor.date') %}
        {% set datetime = strptime(date, '%Y-%m-%d') %}
        {% set timestamp = as_timestamp(datetime) %}

        {{ timestamp | timestamp_custom('%A') }}
      unit_of_measurement: '°C'
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_0d') %}

        {% if icon == 'clear-day' or icon == 'clear-night' %}
          mdi:weather-sunny
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          mdi:weather-partly-cloudy
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_0d') | round }}

    outside_temperature_1:
      friendly_name_template: >-
        {% set date = states('sensor.date') %}
        {% set datetime = strptime(date, '%Y-%m-%d') %}
        {% set timestamp = as_timestamp(datetime) + 1*24*60*60 %}

        {{ timestamp | timestamp_custom('%A') }}
      unit_of_measurement: '°C'
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_1d') %}

        {% if icon == 'clear-day' or icon == 'clear-night' %}
          mdi:weather-sunny
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          mdi:weather-partly-cloudy
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_1d') | round }}

    outside_temperature_2:
      friendly_name_template: >-
        {% set date = states('sensor.date') %}
        {% set datetime = strptime(date, '%Y-%m-%d') %}
        {% set timestamp = as_timestamp(datetime) + 2*24*60*60 %}

        {{ timestamp | timestamp_custom('%A') }}
      unit_of_measurement: '°C'
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_2d') %}

        {% if icon == 'clear-day' or icon == 'clear-night' %}
          mdi:weather-sunny
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          mdi:weather-partly-cloudy
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_2d') | round }}

    outside_temperature_3:
      friendly_name_template: >-
        {% set date = states('sensor.date') %}
        {% set datetime = strptime(date, '%Y-%m-%d') %}
        {% set timestamp = as_timestamp(datetime) + 3*24*60*60 %}

        {{ timestamp | timestamp_custom('%A') }}
      unit_of_measurement: '°C'
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_3d') %}

        {% if icon == 'clear-day' or icon == 'clear-night' %}
          mdi:weather-sunny
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          mdi:weather-partly-cloudy
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_3d') | round }}

    outside_temperature_4:
      friendly_name_template: >-
        {% set date = states('sensor.date') %}
        {% set datetime = strptime(date, '%Y-%m-%d') %}
        {% set timestamp = as_timestamp(datetime) + 4*24*60*60 %}

        {{ timestamp | timestamp_custom('%A') }}
      unit_of_measurement: '°C'
      icon_template: >-
        {% set icon = states('sensor.dark_sky_icon_4d') %}

        {% if icon == 'clear-day' or icon == 'clear-night' %}
          mdi:weather-sunny
        {% elif icon == 'rain' %}
          mdi:weather-rainy
        {% elif icon == 'snow' %}
          mdi:weather-snowy
        {% elif icon == 'sleet' %}
          mdi:weather-snowy-rain
        {% elif icon == 'wind' %}
          mdi:weather-windy-variant
        {% elif icon == 'fog' %}
          mdi:weather-fog
        {% elif icon == 'cloudy' %}
          mdi:weather-cloudy
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          mdi:weather-partly-cloudy
        {% else %}
          unknown
        {% endif %}
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_4d') | round }}

    outside_temperature_high_0:
      friendly_name: High
      icon_template: mdi:thermometer
      unit_of_measurement: '°C'
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_0d') | round }}

    outside_temperature_high_1:
      friendly_name: High
      icon_template: mdi:thermometer
      unit_of_measurement: '°C'
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_1d') | round }}

    outside_temperature_high_2:
      friendly_name: High
      icon_template: mdi:thermometer
      unit_of_measurement: '°C'
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_2d') | round }}

    outside_temperature_high_3:
      friendly_name: High
      icon_template: mdi:thermometer
      unit_of_measurement: '°C'
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_3d') | round }}

    outside_temperature_high_4:
      friendly_name: High
      icon_template: mdi:thermometer
      unit_of_measurement: '°C'
      value_template: >-
        {{ states('sensor.dark_sky_daytime_high_temperature_4d') | round }}

    outside_temperature_low_0:
      friendly_name: Low
      unit_of_measurement: '°C'
      icon_template: mdi:thermometer
      value_template: >-
        {{ states('sensor.dark_sky_overnight_low_temperature_0d') | round }}

    outside_temperature_low_1:
      friendly_name: Low
      unit_of_measurement: '°C'
      icon_template: mdi:thermometer
      value_template: >-
        {{ states('sensor.dark_sky_overnight_low_temperature_1d') | round }}

    outside_temperature_low_2:
      friendly_name: Low
      unit_of_measurement: '°C'
      icon_template: mdi:thermometer
      value_template: >-
        {{ states('sensor.dark_sky_overnight_low_temperature_2d') | round }}

    outside_temperature_low_3:
      friendly_name: Low
      unit_of_measurement: '°C'
      icon_template: mdi:thermometer
      value_template: >-
        {{ states('sensor.dark_sky_overnight_low_temperature_3d') | round }}

    outside_temperature_low_4:
      friendly_name: Low
      unit_of_measurement: '°C'
      icon_template: mdi:thermometer
      value_template: >-
        {{ states('sensor.dark_sky_overnight_low_temperature_4d') | round }}

    outside_temperature_low_friendly_0:
      friendly_name: Low Temperature
      value_template: >-
        {% set temp = states('sensor.dark_sky_overnight_low_temperature_0d') | round %}

        low: {{ temp }}˚

    outside_temperature_low_friendly_1:
      friendly_name: Low Temperature
      value_template: >-
        {% set temp = states('sensor.dark_sky_overnight_low_temperature_1d') | round %}

        low: {{ temp }}˚

    outside_temperature_low_friendly_2:
      friendly_name: Low Temperature
      value_template: >-
        {% set temp = states('sensor.dark_sky_overnight_low_temperature_2d') | round %}

        low: {{ temp }}˚


#
# Friendly icon equivalents
#
# Turns icon names into words and emojis.
#
- platform: template
  sensors:
    weather_emoji:
      friendly_name: Weather Emoji
      icon_template: mdi:sticker-emoji
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon') %}

        {% if icon == 'clear-day' %}
          🌞
        {% elif icon == 'clear-night' %}
          🌜
        {% elif icon == 'rain' %}
          ☔
        {% elif icon == 'snow' %}
          ❄️
        {% elif icon == 'sleet' %}
          ❄️💦
        {% elif icon == 'wind' %}
          🌬️
        {% elif icon == 'fog' %}
          🌫️
        {% elif icon == 'cloudy' %}
          ☁️
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          ⛅
        {% else %}
          ❓
        {% endif %}

    weather_emoji_1:
      friendly_name: Weather Emoji 1
      icon_template: mdi:sticker-emoji
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon_1d') %}

        {% if icon == 'clear-day' %}
          🌞
        {% elif icon == 'clear-night' %}
          🌜
        {% elif icon == 'rain' %}
          ☔
        {% elif icon == 'snow' %}
          ❄️
        {% elif icon == 'sleet' %}
          ❄️💦
        {% elif icon == 'wind' %}
          🌬️
        {% elif icon == 'fog' %}
          🌫️
        {% elif icon == 'cloudy' %}
          ☁️
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          ⛅
        {% else %}
          ❓
        {% endif %}

    weather_icon_friendly:
      friendly_name: Weather Icon
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon') %}

        {% if icon == 'clear-day' or icon == 'clear-night' %}
          Clear
        {% elif icon == 'rain' %}
          Rain
        {% elif icon == 'snow' %}
          Snow
        {% elif icon == 'sleet' %}
          Sleet
        {% elif icon == 'wind' %}
          Windy
        {% elif icon == 'fog' %}
          Fog
        {% elif icon == 'cloudy' %}
          Cloudy
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          Partly Cloudy
        {% else %}
          unknown
        {% endif %}

    weather_icon_friendly_1:
      friendly_name: Weather Icon 1
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon_1d') %}

        {% if icon == 'clear-day' or icon == 'clear-night' %}
          Clear
        {% elif icon == 'rain' %}
          Rain
        {% elif icon == 'snow' %}
          Snow
        {% elif icon == 'sleet' %}
          Sleet
        {% elif icon == 'wind' %}
          Windy
        {% elif icon == 'fog' %}
          Fog
        {% elif icon == 'cloudy' %}
          Cloudy
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          Partly Cloudy
        {% else %}
          unknown
        {% endif %}

    weather_icon_friendly_2:
      friendly_name: Weather Icon 2
      value_template: >-
        {% set icon = states('sensor.dark_sky_icon_2d') %}

        {% if icon == 'clear-day' or icon == 'clear-night' %}
          Clear
        {% elif icon == 'rain' %}
          Rain
        {% elif icon == 'snow' %}
          Snow
        {% elif icon == 'sleet' %}
          Sleet
        {% elif icon == 'wind' %}
          Windy
        {% elif icon == 'fog' %}
          Fog
        {% elif icon == 'cloudy' %}
          Cloudy
        {% elif icon == 'partly-cloudy-day' or icon == 'partly-cloudy-night' %}
          Partly Cloudy
        {% else %}
          unknown
        {% endif %}


#
# Wind speed
#
# The default readings of meters per second is precise, but isn't something
# common mortals use in everyday life. Give me kilometers and wind strenght,
# now *that* I can relate to!
#
# @see /customize.yaml
#
# @link https://en.wikipedia.org/wiki/Beaufort_scale
#
- platform: template
  sensors:
    wind_speed:
      friendly_name: Wind Speed
      unit_of_measurement: 'km/h'
      friendly_name_template: >-
        {{ states('sensor.wind_scale_friendly') }}
      icon_template: >-
        {% set speed = (states('sensor.dark_sky_wind_speed')|float(-1) * 3600 / 1000) %}

        {% if speed >= 39 %}
          mdi:weather-windy
        {% elif speed >= 0 %}
          mdi:airballoon
        {% else %}
          mdi:cloud-question
        {% endif %}
      value_template: >-
        {% set speed = (states('sensor.dark_sky_wind_speed')|float(-1) * 3600 / 1000) %}

        {% if speed >= 0 %}
          {{ speed | round }}
        {% else %}
          unknown
        {% endif %}

    wind_scale_friendly:
      friendly_name: Wind Scale
      icon_template: >-
        {% set speed = (states('sensor.dark_sky_wind_speed')|float(-1) * 3600 / 1000) %}

        {% if speed >= 39 %}
          mdi:weather-windy
        {% elif speed >= 0 %}
          mdi:airballoon
        {% else %}
          mdi:cloud-question
        {% endif %}
      value_template: >-
        {% set speed = (states('sensor.dark_sky_wind_speed')|float(-1) * 3600 / 1000) %}

        {% if speed >= 118 %}
          Hurricane force
        {% elif speed >= 103 %}
          Violent storm
        {% elif speed >= 89 %}
          Storm
        {% elif speed >= 75 %}
          Strong gale
        {% elif speed >= 62 %}
          Fresh gale
        {% elif speed >= 50 %}
          High wind
        {% elif speed >= 39 %}
          Strong breeze
        {% elif speed >= 29 %}
          Fresh breeze
        {% elif speed >= 20 %}
          Moderate breeze
        {% elif speed >= 12 %}
          Gentle breeze
        {% elif speed >= 6 %}
          Light breeze
        {% elif speed >= 1 %}
          Light air
        {% elif speed >= 0 %}
          Calm
        {% elif speed < 0 %}
          unknown
        {% endif %}


#
# Wind direction
#
# Wind provenance in degrees is great for computers, but pointless for humans.
# Cardinal points make more sense to humans.
#
# @see /customize.yaml
#
# @link http://www.themethodology.net/2013/12/how-to-convert-degrees-to-cardinal.html
# @link https://stackoverflow.com/questions/7490660/converting-wind-direction-in-angles-to-text-words
#
- platform: template
  sensors:
    wind_bearing_cardinal:
      friendly_name: Wind Bearing
      value_template: >-
        {% set degrees = states('sensor.dark_sky_wind_bearing') | int(-1) %}
        {% set directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'] %}

        {% if degrees >= 0 %}
          {% set val = (degrees / 45) | int %}

          {{ directions[(val % 8)] }}
        {% else %}
          unknown
        {% endif %}

    wind_bearing_cardinal_arrow:
      friendly_name: Wind Bearing
      value_template: >-
        {% set degrees = states('sensor.dark_sky_wind_bearing') | int(-1) %}
        {% set directions = ['⬆️','↗️','➡️','↘️','⬇️','↙️','⬅️','↖️'] %}

        {% if degrees >= 0 %}
          {% set val = (degrees / 45) | int %}

          {{ directions[(val % 8)] }}
        {% else %}
          unknown
        {% endif %}

    wind_bearing_cardinal_friendly:
      friendly_name: Wind Bearing
      value_template: >-
        {% set degrees = states('sensor.dark_sky_wind_bearing') | int(-1) %}
        {% set directions = [
          'North',
          'Northeast',
          'East',
          'Southeast',
          'South',
          'Southwest',
          'West',
          'Northwest'
        ] %}

        {% if degrees >= 0 %}
          {% set val = (degrees / 45) | int %}

          {{ directions[(val % 8)] }}
        {% else %}
          unknown
        {% endif %}

    wind_bearing_cardinal_16:
      friendly_name: Wind Bearing
      value_template: >-
        {% set degrees = states('sensor.dark_sky_wind_bearing') | int(-1) %}
        {% set directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'] %}

        {% if degrees >= 0 %}
          {% set val = (degrees / 22.5 + 0.5) | int %}

          {{ directions[(val % 16)] }}
        {% else %}
          unknown
        {% endif %}

    wind_bearing_cardinal_16_friendly:
      friendly_name: Wind Bearing
      value_template: >-
        {% set degrees = states('sensor.dark_sky_wind_bearing') | int(-1) %}
        {% set directions = [
          'North',
          'North-Northeast',
          'Northeast',
          'East-Northeast',
          'East',
          'East-Southeast',
          'Southeast',
          'South-Southeast',
          'South',
          'South-Southwest',
          'Southwest',
          'West-Southwest',
          'West',
          'West-Northwest',
          'Northwest',
          'North-Northwest'
        ] %}

        {% if degrees >= 0 %}
          {% set val = (degrees / 22.5 + 0.5) | int %}

          {{ directions[(val % 16)] }}
        {% else %}
          unknown
        {% endif %}
